<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Notifications</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1>🚀 Notifications</h1>
        <p>Λάβετε ειδοποιήσεις </p>
        
        <button id="enableBtn" class="btn-primary">Ενεργοποίηση Ειδοποιήσεων</button>
        <div id="status"></div>
        
        <div id="registered" style="display: none;">
            <h3>✅ Εγγραφή Επιτυχής!</h3>
            <p>Θα λαμβάνετε ειδοποιήσεις για νέες προσφορές κάθε 30 λεπτά.</p>
            <button id="unsubscribeBtn" class="btn-secondary">Διακοπή Ειδοποιήσεων</button>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAtZ1LXEwGQcVrGMoiYiyo9xyDhu9lCjHY",
            authDomain: "articledetector.firebaseapp.com",
            projectId: "articledetector",
            messagingSenderId: "866234093944",
            appId: "1:866234093944:web:f23944e0be780a21f2388d"
        };

        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();
        
        const statusEl = document.getElementById("status");
        const enableBtn = document.getElementById("enableBtn");
        const unsubscribeBtn = document.getElementById("unsubscribeBtn");
        const registeredDiv = document.getElementById("registered");

        // Check if already registered
        const storedToken = localStorage.getItem('fcm-token');
        if (storedToken) {
            showRegisteredState();
        }

        enableBtn.addEventListener("click", async () => {
            try {
                statusEl.innerHTML = "⏳ Αίτηση άδειας...";
                
                const permission = await Notification.requestPermission();
                if (permission !== "granted") {
                    statusEl.innerHTML = "❌ Δεν δόθηκε άδεια για ειδοποιήσεις";
                    return;
                }

                statusEl.innerHTML = "⏳ Λήψη token...";
                
                const token = await messaging.getToken({
                    vapidKey: "BMUYoavlZX0RLS6XoYOWH5qjmdSbSymftcfi_II0x-fVA8Tq_o86GQ2P8kyTPApgN57WdJPfkPyVEZOkyQ3l4FA"
                });

                statusEl.innerHTML = "⏳ Εγγραφή στον server...";
                
                // Store token via GitHub API (using GitHub Issues as database)
                const response = await fetch(`https://api.github.com/repos/saggelis/NotificationWorker/issues`, {
                    method: "POST",
                    headers: {
                        "Accept": "application/vnd.github.v3+json",
                        "Authorization": "token " + "ghp_YOUR_GITHUB_TOKEN", // Public token for issue creation
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        title: `Device Token: ${new Date().toISOString()}`,
                        body: token,
                        labels: ["device-token"]
                    })
                });

                if (!response.ok) {
                    throw new Error("Failed to register token");
                }

                localStorage.setItem('fcm-token', token);
                showRegisteredState();
                
            } catch (error) {
                console.error("Error:", error);
                statusEl.innerHTML = `❌ Σφάλμα: ${error.message}`;
            }
        });

        unsubscribeBtn.addEventListener("click", () => {
            localStorage.removeItem('fcm-token');
            registeredDiv.style.display = "none";
            enableBtn.style.display = "block";
            statusEl.innerHTML = "";
        });

        function showRegisteredState() {
            enableBtn.style.display = "none";
            registeredDiv.style.display = "block";
            statusEl.innerHTML = "";
        }

        // Handle foreground messages
        messaging.onMessage((payload) => {
            console.log('Message received:', payload);
            if (Notification.permission === 'granted') {
                new Notification(payload.notification.title, {
                    body: payload.notification.body,
                    icon: payload.notification.icon || '/favicon.ico'
                });
            }
        });
    </script>
</body>
</html>